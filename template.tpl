___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Journify GTM Server-Side Template",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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\u003d"
  },
  "description": "Journify - The Composable Customer Data Platform that helps marketers collect and unify customer profiles, define dynamic audiences, and activate them in real-time.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "write_key",
    "displayName": "Write key",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "events_mapping",
    "displayName": "Events mapping",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "ga4_recommended_events",
        "displayName": "GA4 recommended events",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "ga4_recommended_events_enabled",
            "checkboxText": "Include GA4 recommended events",
            "simpleValueType": true,
            "defaultValue": true
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "ga4_recommended_events_mapping",
            "displayName": "GA4 recommended events mapping",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Event name",
                "name": "event_name",
                "type": "TEXT"
              },
              {
                "defaultValue": "",
                "displayName": "Event type",
                "name": "event_type",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "track",
                    "displayValue": "track"
                  },
                  {
                    "value": "page",
                    "displayValue": "page"
                  },
                  {
                    "value": "screen",
                    "displayValue": "screen"
                  },
                  {
                    "value": "identify",
                    "displayValue": "identify"
                  },
                  {
                    "value": "group",
                    "displayValue": "group"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "ga4_recommended_events_enabled",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "defaultValue": [
              {
                "event_name": "add_payment_info",
                "event_type": "track"
              },
              {
                "event_name": "add_shipping_info",
                "event_type": "track"
              },
              {
                "event_name": "add_to_cart",
                "event_type": "track"
              },
              {
                "event_name": "add_to_wishlist",
                "event_type": "track"
              },
              {
                "event_name": "begin_checkout",
                "event_type": "track"
              },
              {
                "event_name": "earn_virtual_currency",
                "event_type": "track"
              },
              {
                "event_name": "exception",
                "event_type": "track"
              },
              {
                "event_name": "generate_lead",
                "event_type": "track"
              },
              {
                "event_name": "join_group",
                "event_type": "track"
              },
              {
                "event_name": "level_end",
                "event_type": "track"
              },
              {
                "event_name": "level_start",
                "event_type": "track"
              },
              {
                "event_name": "level_up",
                "event_type": "track"
              },
              {
                "event_name": "login",
                "event_type": "track"
              },
              {
                "event_name": "page_view",
                "event_type": "page"
              },
              {
                "event_name": "post_score",
                "event_type": "track"
              },
              {
                "event_name": "purchase",
                "event_type": "track"
              },
              {
                "event_name": "refund",
                "event_type": "track"
              },
              {
                "event_name": "remove_from_cart",
                "event_type": "track"
              },
              {
                "event_name": "search",
                "event_type": "track"
              },
              {
                "event_name": "select_content",
                "event_type": "track"
              },
              {
                "event_name": "select_item",
                "event_type": "track"
              },
              {
                "event_name": "select_promotion",
                "event_type": "track"
              },
              {
                "event_name": "share",
                "event_type": "track"
              },
              {
                "event_name": "sign_up",
                "event_type": "track"
              },
              {
                "event_name": "spend_virtual_currency",
                "event_type": "track"
              },
              {
                "event_name": "tutorial_begin",
                "event_type": "track"
              },
              {
                "event_name": "tutorial_complete",
                "event_type": "track"
              },
              {
                "event_name": "unlock_achievement",
                "event_type": "track"
              },
              {
                "event_name": "view_cart",
                "event_type": "track"
              },
              {
                "event_name": "view_item",
                "event_type": "track"
              },
              {
                "event_name": "view_item_list",
                "event_type": "track"
              },
              {
                "event_name": "view_promotion",
                "event_type": "track"
              },
              {
                "event_name": "view_search_results",
                "event_type": "track"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "ga4_enhanced_events",
        "displayName": "GA4 enhanced-measurement events",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "ga4_enhanced_events_enabled",
            "checkboxText": "Include GA4 enhanced-measurement events",
            "simpleValueType": true,
            "defaultValue": true
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "ga4_enhanced_events_mapping",
            "displayName": "GA4 enhanced-measurement events mapping",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Event name",
                "name": "event_name",
                "type": "TEXT"
              },
              {
                "defaultValue": "",
                "displayName": "Event type",
                "name": "event_type",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "track",
                    "displayValue": "track"
                  },
                  {
                    "value": "page",
                    "displayValue": "page"
                  },
                  {
                    "value": "screen",
                    "displayValue": "screen"
                  },
                  {
                    "value": "identify",
                    "displayValue": "identify"
                  },
                  {
                    "value": "group",
                    "displayValue": "group"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "ga4_enhanced_events_enabled",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "defaultValue": [
              {
                "event_name": "page_view",
                "event_type": "page"
              },
              {
                "event_name": "scroll",
                "event_type": "track"
              },
              {
                "event_name": "click",
                "event_type": "track"
              },
              {
                "event_name": "view_search_results",
                "event_type": "track"
              },
              {
                "event_name": "video_start",
                "event_type": "track"
              },
              {
                "event_name": "video_progress",
                "event_type": "track"
              },
              {
                "event_name": "video_complete",
                "event_type": "track"
              },
              {
                "event_name": "file_download",
                "event_type": "track"
              },
              {
                "event_name": "form_start",
                "event_type": "track"
              },
              {
                "event_name": "form_submit",
                "event_type": "track"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "ga4_automatic_events",
        "displayName": "GA4 automatically-collected events",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "ga4_automatic_events_enabled",
            "checkboxText": "Include GA4 automatically-collected events",
            "simpleValueType": true,
            "defaultValue": true
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "ga4_automatic_events_mapping",
            "displayName": "GA4 automatically-collected events mapping",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Event name",
                "name": "event_name",
                "type": "TEXT"
              },
              {
                "defaultValue": "",
                "displayName": "Event type",
                "name": "event_type",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "track",
                    "displayValue": "track"
                  },
                  {
                    "value": "page",
                    "displayValue": "page"
                  },
                  {
                    "value": "screen",
                    "displayValue": "screen"
                  },
                  {
                    "value": "identify",
                    "displayValue": "identify"
                  },
                  {
                    "value": "group",
                    "displayValue": "group"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "ga4_automatic_events_enabled",
                "paramValue": true,
                "type": "EQUALS"
              }
            ],
            "defaultValue": [
              {
                "event_name": "page_view",
                "event_type": "page"
              },
              {
                "event_name": "screen_view",
                "event_type": "page"
              },
              {
                "event_name": "ad_click",
                "event_type": "track"
              },
              {
                "event_name": "ad_exposure",
                "event_type": "track"
              },
              {
                "event_name": "ad_impression",
                "event_type": "track"
              },
              {
                "event_name": "ad_query",
                "event_type": "track"
              },
              {
                "event_name": "ad_reward",
                "event_type": "track"
              },
              {
                "event_name": "adunit_exposure",
                "event_type": "track"
              },
              {
                "event_name": "app_clear_data",
                "event_type": "track"
              },
              {
                "event_name": "app_exception",
                "event_type": "track"
              },
              {
                "event_name": "app_remove",
                "event_type": "track"
              },
              {
                "event_name": "app_store_refund",
                "event_type": "track"
              },
              {
                "event_name": "app_store_subscription_cancel",
                "event_type": "track"
              },
              {
                "event_name": "app_store_subscription_convert",
                "event_type": "track"
              },
              {
                "event_name": "app_store_subscription_renew",
                "event_type": "track"
              },
              {
                "event_name": "app_update",
                "event_type": "track"
              },
              {
                "event_name": "click",
                "event_type": "track"
              },
              {
                "event_name": "dynamic_link_app_open",
                "event_type": "track"
              },
              {
                "event_name": "dynamic_link_app_update",
                "event_type": "track"
              },
              {
                "event_name": "dynamic_link_first_open",
                "event_type": "track"
              },
              {
                "event_name": "error",
                "event_type": "track"
              },
              {
                "event_name": "file_download",
                "event_type": "track"
              },
              {
                "event_name": "firebase_campaign",
                "event_type": "track"
              },
              {
                "event_name": "firebase_in_app_message_action",
                "event_type": "track"
              },
              {
                "event_name": "firebase_in_app_message_dismiss",
                "event_type": "track"
              },
              {
                "event_name": "firebase_in_app_message_impression",
                "event_type": "track"
              },
              {
                "event_name": "first_open",
                "event_type": "track"
              },
              {
                "event_name": "first_visit",
                "event_type": "track"
              },
              {
                "event_name": "form_start",
                "event_type": "track"
              },
              {
                "event_name": "form_submit",
                "event_type": "track"
              },
              {
                "event_name": "in_app_purchase",
                "event_type": "track"
              },
              {
                "event_name": "notification_dismiss",
                "event_type": "track"
              },
              {
                "event_name": "notification_foreground",
                "event_type": "track"
              },
              {
                "event_name": "notification_open",
                "event_type": "track"
              },
              {
                "event_name": "notification_receive",
                "event_type": "track"
              },
              {
                "event_name": "os_update",
                "event_type": "track"
              },
              {
                "event_name": "scroll",
                "event_type": "track"
              },
              {
                "event_name": "session_start",
                "event_type": "track"
              },
              {
                "event_name": "user_engagement",
                "event_type": "track"
              },
              {
                "event_name": "video_complete",
                "event_type": "track"
              },
              {
                "event_name": "video_progress",
                "event_type": "track"
              },
              {
                "event_name": "video_start",
                "event_type": "track"
              },
              {
                "event_name": "view_search_results",
                "event_type": "track"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "additional_mappings",
        "displayName": "Additional mappings",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "SIMPLE_TABLE",
            "name": "additional_events_mapping",
            "displayName": "Additional events mapping",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Source event name",
                "name": "event_name",
                "type": "TEXT"
              },
              {
                "defaultValue": "",
                "displayName": "Journify event type",
                "name": "event_type",
                "type": "SELECT",
                "selectItems": [
                  {
                    "value": "track",
                    "displayValue": "track"
                  },
                  {
                    "value": "page",
                    "displayValue": "page"
                  },
                  {
                    "value": "screen",
                    "displayValue": "screen"
                  },
                  {
                    "value": "identify",
                    "displayValue": "identify"
                  },
                  {
                    "value": "group",
                    "displayValue": "group"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "event_properties",
    "displayName": "Additional event properties",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "additional_event_props",
        "displayName": "Additional event properties",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Key",
            "name": "key",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "valueValidators": []
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "page_properties",
    "displayName": "Additional page properties",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "additional_page_props",
        "displayName": "Additional page properties",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Key",
            "name": "key",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "screen_properties",
    "displayName": "Additional screen properties",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "additional_screen_props",
        "displayName": "Additional screen properties",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Key",
            "name": "key",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "user_info",
    "displayName": "User info",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "user_id",
        "displayName": "User ID event key",
        "simpleValueType": true,
        "defaultValue": "user_id",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "group_id",
        "displayName": "Group ID event key",
        "simpleValueType": true,
        "defaultValue": "group_id",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "anonymous_id",
        "displayName": "Anonymous ID event key",
        "simpleValueType": true,
        "defaultValue": "client_id",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "external_ids",
        "displayName": "External IDs",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "ID value",
            "name": "id",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Type (e.g: phone, email)",
            "name": "type",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Collection",
            "name": "collection",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "users",
                "displayValue": "users"
              },
              {
                "value": "accounts",
                "displayValue": "accounts"
              }
            ]
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "traits_mapping",
        "displayName": "Traits mapping",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Source event key",
            "name": "source_event_key",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Journify trait key",
            "name": "trait_key",
            "type": "TEXT"
          }
        ],
        "defaultValue": [
          {
            "source_event_key": "user_data.email_address",
            "trait_key": "email"
          },
          {
            "source_event_key": "user_data.phone_number",
            "trait_key": "phone"
          },
          {
            "source_event_key": "user_data.first_name",
            "trait_key": "firstname"
          },
          {
            "source_event_key": "user_data.last_name",
            "trait_key": "lastname"
          },
          {
            "source_event_key": "user_data.street",
            "trait_key": "street_address"
          },
          {
            "source_event_key": "user_data.city",
            "trait_key": "city"
          },
          {
            "source_event_key": "user_data.region",
            "trait_key": "state_code"
          },
          {
            "source_event_key": "user_data.postal_code",
            "trait_key": "postal_code"
          },
          {
            "source_event_key": "user_data.country",
            "trait_key": "country_code"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "context",
    "displayName": "Context mapping",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "user_agent",
        "displayName": "User agent event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "user_agent"
      },
      {
        "type": "TEXT",
        "name": "locale",
        "displayName": "Locale event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "language"
      },
      {
        "type": "TEXT",
        "name": "session_id",
        "displayName": "Session ID event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "ga_session_id"
      },
      {
        "type": "TEXT",
        "name": "page_referrer",
        "displayName": "Referrer event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "page_referrer"
      },
      {
        "type": "TEXT",
        "name": "page_title",
        "displayName": "Page title event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "page_title"
      },
      {
        "type": "TEXT",
        "name": "page_path",
        "displayName": "Page path event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "page_path"
      },
      {
        "type": "TEXT",
        "name": "page_url",
        "displayName": "Page location event key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "page_location"
      },
      {
        "type": "TEXT",
        "name": "utm_source",
        "displayName": "UTM source param key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "utm_source"
      },
      {
        "type": "TEXT",
        "name": "utm_medium",
        "displayName": "UTM medium param key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "utm_medium"
      },
      {
        "type": "TEXT",
        "name": "utm_campaign",
        "displayName": "UTM campaign param key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "utm_campaign"
      },
      {
        "type": "TEXT",
        "name": "utm_term",
        "displayName": "UTM term param key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "utm_term"
      },
      {
        "type": "TEXT",
        "name": "utm_content",
        "displayName": "UTM content param key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "utm_content"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "other_settings",
    "displayName": "Other settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "api_url",
        "displayName": "API URL (optional)",
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// import dependencies
const Object = require('Object');
const getEventData = require('getEventData');
const getTimestampMillis = require('getTimestampMillis');
const getRemoteAddress = require('getRemoteAddress');
const sendHttpRequest = require('sendHttpRequest');
const JSON = require('JSON');
const log = require('logToConsole');
const parseUrl = require('parseUrl');
const makeNumber = require('makeNumber');
const makeTableMap = require('makeTableMap');
const getAllEventData = require('getAllEventData');

// define functions
function getEventName() {
    let eventName = getEventData('event_name');
    if (!eventName) {
        eventName = getEventData('event');
    }

    return eventName;
}

function getEventType(eventName) {
    const mappings = [];
    if (data.ga4_recommended_events_enabled === true && data.ga4_recommended_events_mapping && data.ga4_recommended_events_mapping.length > 0) {
        mappings.push(data.ga4_recommended_events_mapping);
    }

    if (data.ga4_enhanced_events_enabled === true && data.ga4_enhanced_events_mapping && data.ga4_enhanced_events_mapping.length > 0) {
        mappings.push(data.ga4_enhanced_events_mapping);
    }

    if (data.ga4_automatic_events_enabled === true && data.ga4_automatic_events_mapping && data.ga4_automatic_events_mapping.length > 0) {
        mappings.push(data.ga4_automatic_events_mapping);
    }

    if (data.additional_events_mapping && data.additional_events_mapping.length > 0) {
        mappings.push(data.additional_events_mapping);
    }

    const eventsMap = {};
    for (let i = 0; i < mappings.length; i++) {
        const currentMap = makeTableMap(mappings[i], 'event_name', 'event_type');
        copyObj(eventsMap, currentMap);
    }

    return eventsMap[eventName];
}

function getUserTraits() {
    const eventData = getAllEventData();
    log('getUserTraits, eventData: '+ JSON.stringify(eventData));

    const traitKeysMapping = makeTableMap(data.user_traits_mapping || [], 'source_event_key', 'trait_key');
    const templateTraits =  getEventDataKeys(Object.keys(traitKeysMapping || {}));

    const domainTraits = {};
    for (let key in templateTraits) {
        const domainKey = traitKeysMapping[key];
        domainTraits[domainKey] = templateTraits[key];
    }

    return domainTraits;
}

function getEventDataKeys(keys){
    const object = {};
    for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const value = getEventData(key);
        if (value) {
            object[key] = value;
        }
    }

    return object;
}

function getContext(){
    const context = {
        userAgent: getEventData(data.user_agent),
        page: getPageProperties(),
        locale: getEventData(data.locale),
        ip: getRemoteAddress(),
        library: {
            name: "journifyio-server-gtm",
        },
        session: {
            id: makeNumber(getEventData(data.session_id)),
        }
    };

    const utmCampaign = getUtmCampaign();
    if (utmCampaign) {
        context.campaign = utmCampaign;
    }

    return context;
}

function getPageProperties() {
    const pageKeysMapping = {
        "referrer": data.page_referrer,
        "title": data.page_title,
        "path": data.page_path,
        "url": data.page_url,
    };

    const templatePage =  getEventDataKeys(Object.values(pageKeysMapping));
    const domainPage = {};
    for (let key in pageKeysMapping) {
        const templateKey = pageKeysMapping[key];
        domainPage[key] = templatePage[templateKey];
    }

    return domainPage;
}

function getUtmCampaign() {
    const url = getEventData(data.page_url);
    if (!url) {
        return null;
    }

    const parsedUrl = parseUrl(url);
    if (parsedUrl && Object.keys(parsedUrl.searchParams || {}).length > 0) {
        const utmKeysMapping = {
            "source": data.utm_source,
            "medium": data.utm_medium,
            "campaign": data.utm_campaign,
            "term": data.utm_term,
            "content": data.utm_content,
        };

        let campaignFound = false;
        const utmCampaign = {};

        for (let key in utmKeysMapping) {
            const paramKey = utmKeysMapping[key];
            const paramValue = parsedUrl.searchParams[paramKey];
            if (paramValue) {
                campaignFound = true;
                utmCampaign[key] = paramValue;
            }
        }

        return campaignFound ? utmCampaign : null;
    }

    return null;
}

function getEventProperties(eventType) {
    const propertyKeys = [
        'accept_time',
        'achievement_id',
        'aclid',
        'ad_event_id',
        'ad_unit_code',
        'affiliation',
        'anid',
        'campaign',
        'campaign_info_source',
        'cancellation_reason',
        'character',
        'click_timestamp',
        'client_id',
        'content',
        'content_id',
        'content_type',
        'coupon',
        'cp1',
        'creative_name',
        'creative_slot',
        'currency',
        'deferred_analytics_collection',
        'discount',
        'engagement_time_msec',
        'exposure_time',
        'fatal',
        'file_extension',
        'file_name',
        'firebase_error',
        'firebase_error_value',
        'firebase_previous_class',
        'firebase_previous_id',
        'firebase_previous_screen',
        'firebase_screen',
        'firebase_screen_class',
        'firebase_screen_id',
        'form_destination',
        'form_id',
        'form_name',
        'form_start',
        'form_submit_text',
        'free_trial',
        'gclid',
        'group_id',
        'index',
        'introductory_price',
        'item_brand',
        'item_category',
        'item_category2',
        'item_category3',
        'item_category4',
        'item_category5',
        'item_id',
        'item_list_id',
        'item_list_name',
        'item_name',
        'item_variant',
        'items',
        'label',
        'language',
        'level',
        'level_name',
        'link_classes',
        'link_domain',
        'link_id',
        'link_text',
        'link_url',
        'location_id',
        'medium',
        'message_channel',
        'message_device_time',
        'message_id',
        'message_name',
        'message_time',
        'method',
        'outbound',
        'page_encoding',
        'page_location',
        'page_referrer',
        'page_title',
        'payment_type',
        'previous_first_open_count',
        'previous_gmp_app_id',
        'previous_os_version',
        'price',
        'product_id',
        'promotion_id',
        'promotion_name',
        'quantity',
        'renewal_count',
        'reset_analytics_cause',
        'reward_type',
        'reward_value',
        'score',
        'screen_resolution',
        'search_term',
        'shipping',
        'shipping_tier',
        'source',
        'subscription',
        'success',
        'system_app',
        'system_app_update',
        'tax',
        'term',
        'timestamp',
        'topic',
        'transaction_id',
        'unique_search_term',
        'updated_with_analytics',
        'user_agent',
        'value',
        'video_current_time',
        'video_duration',
        'video_percent',
        'video_provider',
        'video_title',
        'video_url',
        'virtual_currency_name',
        'visible'
    ];

    const properties = getEventDataKeys(propertyKeys);

    const nestedProps = getEventData('properties');
    if (nestedProps) {
        copyObj(properties, nestedProps);
    }

    const ecommerce = getEventData('ecommerce');
    if (ecommerce) {
        copyObj(properties, ecommerce);
    }

    copyObj(properties, ecommerce);

    switch (eventType) {
        case 'track':
            appendProperties(properties, data.additional_event_props);
            break;
        case 'page':
            appendProperties(properties, data.additional_page_props);
            break;
        case 'screen':
            appendProperties(properties, data.additional_screen_props);
            break;
    }

    return properties;
}

function appendProperties(properties, valuesObject) {
    for (let i = 0; i < valuesObject.length; i++) {
        const current = valuesObject[i];
        properties[current.key] = current.value;
    }
}

function copyObj(target, source) {
    for (let key in source) {
        target[key] = source[key];
    }
}

// Main
// create event
const eventName = getEventName();
const eventType = getEventType(eventName);
if (!eventType) {
    log('No event name match, aborting event dispatch.');
    return data.gtmOnSuccess();
}

const timestamp = getTimestampMillis();
const client_id = getEventData('client_id');
const message_id = getEventData('user_id') + client_id + eventName + timestamp;

const event = {
    type: eventType,
    event: eventName,
    anonymousId: getEventData(data.anonymous_id),
    userId: getEventData(data.user_id),
    group_id: getEventData(data.group_id),
    externalIds: data.external_ids || [],
    writeKey: data.write_key,
    timestampMillis: timestamp,
    messageId : message_id,
    traits: getUserTraits(),
    context: getContext(),
    properties: getEventProperties(eventType),
};

if (eventType === 'page') {
    event.name = getEventData(data.page_title);
}

// send event
const apiURL = data.api_url && data.api_url.length > 0 ? data.api_url : "https://t.journify.io";
const queryEndpoint = apiURL + '/v1/' + eventType.charAt(0);

const queryCallback = (statusCode, headers, body) => {
    log("response", "statusCode: ", statusCode, "body: ", JSON.stringify(body));
    if (statusCode >= 400) {
        data.gtmOnFailure();
    } else {
        data.gtmOnSuccess();
    }
};

const queryOptions = {
    headers: {'content-type': 'application/json'},
    method: 'POST',
    timeout: 2000,
};

const queryBody = JSON.stringify(event);

sendHttpRequest(queryEndpoint, queryCallback, queryOptions, queryBody);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12/20/2023, 3:38:56 PM


